---
output: pdf_document
---


```{r include=FALSE}
knitr::opts_chunk$set(fig.path = 'figurasR/',
                      echo = FALSE, warning = FALSE, message = FALSE,
                      fig.pos="H",out.extra = '',fig.align="center",out.width="95%",
                      cache=FALSE)
```




<!-- \setcounter{chapter}{2} -->
<!-- \setcounter{chapter}{2} escribir 2 para capítulo 3  -->
<!-- \pagenumbering{arabic} -->

\ifdefined\ifprincipal
\else
\setlength{\parindent}{1em}
\pagestyle{fancy}
\setcounter{tocdepth}{4}
\tableofcontents
<!-- \nocite{*} -->
\fi

\ifdefined\ifdoblecara
\fancyhead{}{}
\fancyhead[LE,RO]{\scriptsize\rightmark}
\fancyfoot[LO,RE]{\scriptsize\slshape \leftmark}
\fancyfoot[C]{}
\fancyfoot[LE,RO]{\footnotesize\thepage}
\else
\fancyhead{}{}
\fancyhead[RO]{\scriptsize\rightmark}
\fancyfoot[LO]{\scriptsize\slshape \leftmark}
\fancyfoot[C]{}
\fancyfoot[RO]{\footnotesize\thepage}
\fi
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}



```{r , message=FALSE , echo= FALSE}

library(tidyverse)
library(dplyr)
library(kableExtra)

library(plyr) # Transformación de los datos
library(dplyr)


library(lubridate)
library(ggplot2) # Visualización
library(hrbrthemes) # Temas 

library(TSA) # Series Temporales (B-C) (Not working)
library(tseries) # Test de raíz unitaria
library(forecast) # Diagnosis del modelo

```




```{r}
load("Datos/VENTAS_Dia_CALCIO.RData")
load("Datos/VENTAS_Dia_SCALCIO.RData")
load("Datos/VENTAS_Dia_TOTAL.RData")
```


### Modelado

A continuación, se expone la aplicación de los modelos predictivos estudiados con el objetivo de predecir la demanda de productos diaria a partir de las siguientes variables explicativas: precio medio con impuestos, descuento medio, año, mes y día de la semana.

Para cada algoritmo, se construirán tres modelos:

- Predicción del volumen de total de ventas diario (producto con calcio y sin calcio)
- Predicción del volumen de ventas diario para el producto con calcio
- Predicción del volumen de ventas diario para el producto sin calcio

Posteriormente, realizaremos una comparación de las predicciones de la suma de productos con la suma de las predicciones proporcionadas por cada modelo individual.

Para los diferentes modelos entrenados, se recogerá su rendimiento para posteriormente compararlos y elegir el mejor modelo para predecir la demanda.




#### Modelos estadísticos clásicos



**Partición de los datos en los modelos de regresión**:

Se ha tomado una partición de 80% 20% para datos de entrenamiento y testeo, con el objetivo de entrenar el modelo para posteriormente estudiar su rendimiento y capacidad de generalización.


```{r , echo=TRUE}
n=nrow(VolVentas_FECHA_poiss)
indin= 1:n
nent=ceiling(0.8*n) # número de registros de entrenamiento
ntest= n-nent # número de registros de testeo
set.seed(100822)
indient= sort(sample(indin,nent)) # índices de entrenamiento
inditest= setdiff(indin,indient) # índices de testeo
```


```{r}

Ventas_TOTAL_ENT_poiss = VolVentas_FECHA_poiss[indient,-c(3,6)]
Ventas_TOTAL_TEST_poiss=VolVentas_FECHA_poiss[inditest,-c(3,6)]

Ventas_TOTAL_ENT= VolVentas_FECHA[indient,-c(3,6)]
Ventas_TOTAL_TEST=VolVentas_FECHA[inditest,-c(3,6)]


Ventas_CALCIO_ENT_poiss= VolVentas_CALCIO_FECHA_poiss[indient,-c(3,6)]
Ventas_CALCIO_TEST_poiss=VolVentas_CALCIO_FECHA_poiss[inditest,-c(3,6)]

Ventas_CALCIO_ENT= VolVentas_CALCIO_FECHA[indient,-c(3,6)]
Ventas_CALCIO_TEST=VolVentas_CALCIO_FECHA[inditest,-c(3,6)]



Ventas_SIN_CALCIO_ENT_poiss= VolVentas_SIN_CALCIO_FECHA_poiss[indient,-c(3,6)]
Ventas_SIN_CALCIO_TEST_poiss=VolVentas_SIN_CALCIO_FECHA_poiss[inditest,-c(3,6)]


Ventas_SIN_CALCIO_ENT= VolVentas_SIN_CALCIO_FECHA[indient,-c(3,6)]
Ventas_SIN_CALCIO_TEST=VolVentas_SIN_CALCIO_FECHA[inditest,-c(3,6)]
```




```{r child = 'ModeladoClasico.Rmd'}
```





#### Técnicas de aprendizaje automático


El objetivo del presente apartado es predecir el volumen de ventas haciendo uso de los siguientes algoritmos de regresión: máquinas de vector soporte (SVM), KNN y árboles de decisión, en particular XGBoost.
Todos estos algoritmos serán aplicados haciendo uso de la función *train* de la librería *caret*. El principal objetivo de usar la misma función para todos los modelos es poder comparar el rendimiento de éstos y seleccionar el mejor algoritmo para predecir el volumen de ventas.


Para el desarrollo de los modelos, haremos uso de los conjuntos de datos de `r nrow(VolVentas_CALCIO_FECHA)` filas generados en el apartado de pre-procesado y limpieza de los datos, siendo las variables predictoras las siguientes mostradas a continuación:

- Precio medio con impuestos
- Descuento medio aplicado
- Año
- Mes del año
- Día de la semana













```{r child = 'Modelado_A_Automatico.Rmd'}
```




