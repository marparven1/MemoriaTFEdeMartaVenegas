---
author: "Nombre Completo Autor"
date: "27/10/2017"
documentclass: book
forprint: true  # true: imprime a dos caras, false: libro digital
fontsize: 12pt # 10pt,11pt
geometry: margin = 2.5cm 
bibliography: ["bib/library.bib", "bib/paquetes.bib"]
# metodobib -> true: natbib (descomentar: citation_package: natbib) 
#           -> false: pandoc (comentar: citation_package: natbib)
metodobib: true
#natbib: plainnat, abbrvnat, unsrtnat
biblio-style: "plainnat"
#Método 2 (pandoc): descomente una línea de las 2 siguientes en caso de usarlo
csl: methods-in-ecology-and-evolution.csl      # no numera mejor en las citas
#csl: acm-sig-proceedings-long-author-list.csl  # numera peor en las citas
link-citations: yes
output: 
  pdf_document:
    keep_tex: no
    number_sections: yes
    citation_package: natbib  # comentado usa: pandoc-citeproc
    #toc: yes
    fig_caption: yes
    template: latex/templateMemoriaTFE.tex
    includes:
      #before_body: portadas/latex_paginatitulo_modTFE.tex
      #in_header: latex/latex_preambulo.tex
      #after_body: latex/latex_antes_enddoc.tex
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r , librerias, message=FALSE , echo= FALSE}
library(tidyverse)
library(dplyr)
library(kableExtra)

library(plyr) # Transformación de los datos

library(arules) # Análisis de reglas de asocicación
library(arulesViz) # Visualización de reglas de asociación

library(ggplot2) # Visualización
```




## Análisis de cesta de la compra para productos lácteos


### Introducción

El objetivo principal es aplicar un análisis de cesta de la compra para un conjunto de datos con una muestra de 7801 tickets que incluyen 4631 artículos distintos.

Aplicaremos esta técnica para descubrir los patrones de compra de los clientes y tratar así de identificar las relaciones existentes entre productos a la hora de comprar.

Para llevar a cabo este estudio, haremos uso de la librería *arules*, que se trata de un entorno creado para la identificación de reglas de asociación y conjuntos de items frecuentes.

### Lectura y descripción de los datos




```{r}
load("Datos/muestraTickets.RData")
```

Los datos corresponden a **poner** y se encuentran en formato dataFrame. Contienen información correspondiente a transacciones de **¿?**.

Cada fila de nuestro conjunto de datos corresponde a una línea de un ticket y por tanto, una fila se corresponde con un determinado producto. Por este motivo, para una única transacción encontraremos tantas filas como productos diferentes se hayan comprado, ya que tambien encontramos registrada la cantidad de producto.

En el conjunto de datos encontramos las siguientes variables:

- **Idticket**: Variable numérica que identifica unívocamente a cada ticket
- **linea**: Variable numérica con la línea correspondiente del ticket
- **item**: Item concreto
- **cantidad**: Se trata de la cantidad de unidades que se ha comprado de un determinado ítem en una transacción concreta


```{r}
transacciones <- as.data.frame(muestra)
transacciones %>% head()
```







Para aplicar un análisis de cesta de la compra necesitamos que nuestros datos estén en formato *cesta* (formato basket). Antes de transformar los datos, vamos a hacer el preprocesado pertinente para tener todas las variables con un formato adecuado. 

Es necesario que cada línea de nuestro dataset corresponda a una única transacción, es decir, que en cada fila estén contenidos todos los productos que se refieren a sola transacción.

Por ello, únicamente necesitamos una columna en la que tengamos recogidos todos los items perteneceientes a una transacción, ya que tendremos tantas filas como transacciones, es decir, tantas filas como tickets.

Existen un total de   `r transacciones$item %>% unique() %>% length()` productos y `r transacciones$Idticket %>% unique() %>% length()` transacciones.



```{r}
#transacciones$Idticket <- as.factor(transacciones$Idticket) 
## transacciones$linea<- as.factor(transacciones$linea)
#transacciones$item <- as.factor(transacciones$item)
## transacciones$cantidad<- as.factor(transacciones$cantidad)
```

```{r}
transacciones %>% glimpse()
```


A continuación vamos a ver las seis últimas filas de nuestro nuevo conjunto de datos.

```{r}
TicketsAgrupados<-transacciones %>% group_by(Idticket) %>% select(item,linea)

DatosBasket <- ddply(TicketsAgrupados, c("Idticket"), 
                             function(TicketsAgrupados)
                               paste(TicketsAgrupados$item, collapse = ","))

DatosBasket1 <- DatosBasket %>% rename("Transaccion" = V1)
DatosBasket1 %>% tail() %>% kable(booktabs=TRUE) %>% kable_styling(latex_options = "striped")
```


```{r}
a<-transacciones %>% group_by(Idticket)
lista = list()

for (i in seq_len(nrow(transacciones))) {
  lista[[i]] =c(rep(a[i,3] %>% unlist(use.names = FALSE),a[i,4]))
}

lista %>% head()
```


```{r}
df = data.frame()

for (i in seq_len(length(lista))) {
  df[i,1] = paste(lista[[i]], collapse=",")
}
```


```{r}
df$Idticket <-  transacciones$Idticket
df %>% head()

```





Guardamos este conjunto de datos en formato csv para su correcta lectura en formato basket haciendo uso de la función *read.transactions* perteneciente a la librería *arules*.


```{r}
cestas <- DatosBasket1$Transaccion %>%as_tibble() %>% dplyr::rename("Transaccion" = value)
write.csv(cestas,"Datos/muestraTickets.csv", quote = FALSE, row.names = FALSE)
```


```{r}
TransBasket <- read.transactions("Datos/muestraTickets.csv", 
                                 format = 'basket', sep=',',
                                 header = TRUE )
TransBasket
summary(TransBasket)
```


Observamos que hay un total de 7801 transacciones y 4631 artículos. Las transacciones son los subconjuntos de estos 4631 artículos.

En el resumen de los datos podemos ver otra información previa que nos puede ser útil:

- Density: Se trata del número total de artículos que se han comprado entre el número total de artículos existentes

- Artículos más frecuentes: los productos que más se han comprado han sido el 1033, el 28716, el 1096, 26785 y 24347

Productos más frecuentes:

| ID Producto          | Cota inferior de unidades vendidas |
|----------------------|------------------------------------|
| 1033                 | 507                                |
| 28716                | 451                                |
| 1096                 | 358                                |
| 26785                | 294                                |
| 24347                | 266                                |
| Otro                 | 40371                              |

: Productos más frecuentes

A continuación vamos a ver una lista con algunas transacciones:

```{r}
LIST(TransBasket) %>% head(5)
```


- Tamaño de las transacciones: 1847 transacciones fueron de un único artículo y 1285 transacciones fueron de dos artículos, indicando estos resultados que la mayoría de clientes compraron entre 1 y 2 artículos en cada transacción. La transacción con más productos diferentes ha sido una transacción con 82 artículos.

Nota: Cabe destacar que esto se trata de una cota inferior, es decir, para una transacción con un único artículo, sabemos que se compró al menos una vez, pero no sabemos cuantos items compró de ese artículo.

A continaucón vamos a mostrar gráficamente cuáles han sido los 15 artículos más comprados y el número de transacciones en las que aparece ese artículo.


```{r}
# Create an item frequency plot for the top 20 items
if (!require("RColorBrewer")) {
  # install color package of R
install.packages("RColorBrewer")
#include library RColorBrewer
library(RColorBrewer)
}
itemFrequencyPlot(TransBasket,topN=20,type="absolute",col=brewer.pal(8,'Pastel2'), main="15 artículos más compra")



ggplot(data=transacciones, 
       aes(x=reorder(Idticket,item) , 
        y = cantidad , fill= item)) + 
    geom_bar(stat="identity", position="dodge") +
    labs(title="Tipo de producto y volumen de ventas del último mes" ,
         subtitle= "Electronidex", 
         caption="Fuente: Elaboración propia. Conjunto de datos de transacciones"
        )+
  xlab("Tipo de producto")+
  ylab("Volumen de Ventas")+
  theme(axis.text.x = element_text(angle = 60, hjust = 1))


```






### Aplicación del algoritmo a priori

### Conclusiones




