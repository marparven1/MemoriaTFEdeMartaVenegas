---
output: pdf_document
---



```{r include=FALSE}
knitr::opts_chunk$set(fig.path = 'figurasR/',
                      echo = FALSE, warning = FALSE, message = FALSE,
                      fig.pos="H",fig.align="center",out.width="95%",
                      cache=FALSE)

```









<!-- \setcounter{chapter}{2} -->
<!-- \setcounter{chapter}{2} escribir 2 para capítulo 3  -->
<!-- \pagenumbering{arabic} -->

\ifdefined\ifprincipal
\else
\setlength{\parindent}{1em}
\pagestyle{fancy}
\setcounter{tocdepth}{4}
\tableofcontents
<!-- \nocite{*} -->
\fi

\ifdefined\ifdoblecara
\fancyhead{}{}
\fancyhead[LE,RO]{\scriptsize\rightmark}
\fancyfoot[LO,RE]{\scriptsize\slshape \leftmark}
\fancyfoot[C]{}
\fancyfoot[LE,RO]{\footnotesize\thepage}
\else
\fancyhead{}{}
\fancyhead[RO]{\scriptsize\rightmark}
\fancyfoot[LO]{\scriptsize\slshape \leftmark}
\fancyfoot[C]{}
\fancyfoot[RO]{\footnotesize\thepage}
\fi
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}



```{r , message=FALSE , echo= FALSE}
library(tidyverse)
library(dplyr)
library(kableExtra)

library(plyr) # Transformación de los datos
library(dplyr)


library(lubridate)
library(ggplot2) # Visualización
library(hrbrthemes) # Temas 
library(corrplot)
library(TSA) # Series Temporales (B-C)
```





## Proceso de la ciencia de datos


Este apartado lo dedicaremos a realizar un proceso de ciencia de datos completo, teniendo en cuenta los siguientes objetivos:

- Analizar los datos proporcionados para conocer como varían las ventas de dos productos lácteos con el tiempo.
- Demostrar que existe la posibilidad de construir buenos modelos para predecir el volumen futuro de venta de productos a partir de los datos.
- Desarrollo de modelos para predecir ventas.



### Lectura y descripción de los datos



```{r }
load("Datos/datosTFGMarta.RData")
```




Los datos contienen información correspondiente a ventas de dos productos lácteos (uno con calcio y otro sin calcio) durante un período de 5 meses, desde el 1 de Septiembre de 2020 hasta el 30 de Enero de 2021, obteniéndose un total de 140025 observaciones y se estructuran de la siguiente forma: cada fila corresponde a la línea de un ticket y hace referencia a la venta de un artículo en particular.


En este conjunto de datos inicial encontramos las siguientes variables:

- **Id de ticket**: Variable numérica que identifica unívocamente a cada ticket de venta.
- **Línea de ticket**: Variable numérica con la línea correspondiente del ticket.
- **Fecha**: Fecha en que se realizó la venta.
- **Código**: Identificador del producto.
- **Cantidad**: Número de items vendidos de un determinado producto.
- **Precio**: Precio base del artículo libre de impuestos, euros.
- **Precio con impuestos**: Precio de venta del artículo, en  euros.
- **Descuento**:  Descuento aplicado.
- **Importe**: Importe de la compra libre de impuestos, en euros.
- **Importe con impuestos**: Importe a pagar por el comprador, en euros.



### Preparación de los datos (Preprocesado)

En este paso, vamos a llevar a cabo la limpieza de los datos para su posterior estudio, representación y modelado. En este punto del proceso, trataremos de encontrar, corregir o eliminar registros erróneos en los datos. 


#### Transformación de los datos


Hay algunas variables que necesitan ser transformadas, en particular, la variable código, la cantidad de artículos vendidos y linea del ticket han sido transformadas para tenerlas en un formato adecuado. Vamos a visualizar la nueva estructura de los datos:

```{r }
#datos$ID_TICKET<- as.factor(datos$ID_TICKET) # Conversión a factor
datos$LINEA_TICKET<- as.factor(datos$LINEA_TICKET) # Conversión a factor
datos$CODIGO<- as.factor(datos$CODIGO) # Conversión a factor
datos$CANTIDAD<- as.integer(datos$CANTIDAD) # Conversión a entero
dataset<-as.data.frame(datos) # Datos como DF
```


```{r , echo=TRUE  , size="footnotesize"}
dataset %>% str() # Estructura de los datos trás reformateo
```



#### Duplicados


Se comprueba la existencia de registros duplicados y concluímos que no existen duplicados.

```{r DUPLICADOS ,echo=TRUE}
dataset[duplicated(dataset)==TRUE,]
```





#### Datos faltantes



Al estar trabajando con fechas, es muy importante comprobar la uniformidad en los datos, para ello buscaremos la existencia de registros faltantes de la siguiente forma:


```{r , missing values ,  echo=TRUE}
# Construcción de datos con todas las fechas entre la primera fecha
#  y la última de los datos que tenemos
FechasCompletas <- seq(min(dataset$FECHA), max(dataset$FECHA), by = "day")

# Creo un DF de fechas
FechasCompletas  <- data.frame(FECHA = FechasCompletas ) 

# Merge al conjunto de fechas completas y al cjto inicial para añadir NA 
# a aquellos valores faltantes
DatosCompletos <- merge(FechasCompletas, dataset, by = "FECHA",
                        all.x = TRUE)

# Valores faltantes en el conjunto de datos completo
Miss_values <- which(is.na(DatosCompletos$ID_TICKET) == TRUE)
```

Con registros faltantes nos referimos a que falten las ventas correspondientes a algún día concreto dentro del período de estudio, 1/09/2020-30/01/2022.

Existen un total de `r length(Miss_values)` valores faltantes, que corresponden a un `r round( (length(Miss_values)/nrow(dataset))*100 , 5 )`% del total de datos. Se trata de un porcentaje ínfimo del total. En otras condiciones, procederíamos a imputar estos valores, sin embargo, estos días no estaban contemplados en el conjunto de datos inicial debido a que corresponden a festivos: `r DatosCompletos[Miss_values[1],1]`, el día de Navidad y `r DatosCompletos[Miss_values[2],1]`, año nuevo. Por tanto, el motivo de la falta de datos es el cierre del establecimiento y por ello, podemos continuar con nuestro análisis haciendo uso del conjunto de datos inicial.



#### Outliers


Estudiamos valores atípicos para las variables *precio con impuestos*, *cantidad* e *importe con impuestos*, ya que estudiarlos para el resto no tiene mucho interés.



```{r}
# fig <- plot_ly(y = ~dataset[,6], type = "box",name="PRECIO")
# fig <- fig %>% layout(title = "BoxPlot de la variable precio ")
# fig
# 
# 
# fig <- plot_ly(y = ~dataset[,4], type = "box",name="CANTIDAD")
# fig <- fig %>% add_trace(y = ~dataset[,9],name="IMPORTE")
# fig <- fig %>% layout(title = "BoxPlot de la cantidad y el importe")
# fig

par(mfrow=c(1,2))
boxplot(dataset[,c(5,9)], main="Cantidad e importe (impuestos)")
boxplot(dataset[,6],main="Precio (impuestos)")
par(mfrow=c(1,1))
```

Para la variable precio con impuestos, un importe menor de 1.2€ se podría considerar un valor extremo, existiendo dos valores atípicos entre los datos con unos precios de venta de 79 y 76 céntimos.
Para la variable cantidad, se considerará un valor atípico la compra de 14 o más artículos. Por último, respecto a la variable importe con impuestos, una compra de más de 18.07€ podemos considerarla como una compra con un valor extremo.


#### Creación de variables

**Variables temporales**

Se ha considerado oportuno la extracción de la siguiente información como nuevas variables temporales: día de la semana, semana del año, mes y año de cada instancia a partir de la variable *fecha* y haciendo uso de la librería lubridate. De esta forma, se podrá hacer un análisis del comportamiento de ventas teniendo en cuenta distintas granularidades tratando de entender cómo afecta la temporalidad a la venta de productos.



```{r , extraccion_fecha , echo=TRUE}
dataset$ANO         <-  year(dataset$FECHA) # Extracción del año
dataset$MES         <- month(dataset$FECHA) # Extracción del mes
dataset$DIA         <-   day(dataset$FECHA) # Extracción del día
dataset$SEMANA_ANO <-   week(dataset$FECHA) # Extracción semana del año
dataset$DIA_SEMANA <-   wday(dataset$FECHA,week_start = 1 )
```


```{r , reordenacion_cols}
# Reordeno las columnas 
dataset <- dataset %>% select("ID_TICKET"  , "LINEA_TICKET", "CODIGO",
                              "CANTIDAD", "PRECIO", "PRECIO_CON_IMPUESTOS" ,
                              "DESCUENTO", "IMPORTE", "IMPORTE_CON_IMPUESTOS" ,
                              "FECHA" , "ANO", "MES"    , "DIA", "SEMANA_ANO",
                              "DIA_SEMANA"  )
```




```{r}
dataset$ANO <-       as.integer(dataset$ANO)
dataset$MES <-       as.integer(dataset$MES)
dataset$DIA <-       as.integer(dataset$DIA)
dataset$SEMANA_ANO<- as.integer(dataset$SEMANA_ANO)
dataset$DIA_SEMANA<- as.integer(dataset$DIA_SEMANA)
```


**Tipo de producto**


Además de las variables temporales, vamos a añadir una nueva variable: *TIPO*, que representa el tipo de producto lácteo, siendo esta una variable categórica que toma dos posibles valores: *Con calcio* o *sin calcio*. El producto que no lleva calcio es aquel con identificador 20445


```{r}
dataset$TIPO = ifelse(
  dataset$CODIGO == 20445 , "Sin Calcio" , "Con calcio"
)

datset = dataset[,c(3,16,1,2,4:15)]
```




#### Datasets de entrada de modelos 


La variable objetivo es el volumen de ventas diario, por lo que necesitamos transformar el conjunto de datos inicial en uno que tenga una variable *ventas* con el número total de items que se venden diariamente. De esta forma, obtendremos tres conjuntos de datos: Uno con el volumen diario total, otro con el volumen de ventas diario del producto sin calcio y un tercer conjunto para el producto con calcio. De esta forma, podremos modelar el volumen de ventas en cada ocasión y posteriormente hacer comparaciones de la suma de las predicciones de los productos por separado con la predicción de la venta de la suma de ambos productos.

```{r }
VolVentas_FECHA = dataset %>%
  group_by(FECHA) %>%
  dplyr::summarise(VENTAS = sum(CANTIDAD),
                   PRECIO_MEDIO_IMPUESTOS = mean(PRECIO_CON_IMPUESTOS),
                   DESCUENTO_MEDIO = mean(DESCUENTO),
                   IMPORTE_MEDIO_IMPUESTOS=mean(IMPORTE_CON_IMPUESTOS)
                   )
NUM_TRANSACCIONES = as.data.frame(datset %>%
                                    group_by(FECHA) %>% 
                                    dplyr::summarise( unique(ID_TICKET) ) %>%
                                    group_by(FECHA) %>% 
                                    dplyr::summarise(n()))$'n()'
VolVentas_FECHA$NUM_TRANSACCIONES =NUM_TRANSACCIONES
VolVentas_FECHA=VolVentas_FECHA[,c(1,2,6,3:5)]

VolVentas_CALCIO_FECHA = dataset %>%
  filter(CODIGO == 22336) %>% 
  group_by(FECHA) %>%
  dplyr::summarise(VENTAS = sum(CANTIDAD),
                   PRECIO_MEDIO_IMPUESTOS = mean(PRECIO_CON_IMPUESTOS),
                   DESCUENTO_MEDIO = mean(DESCUENTO),
                   IMPORTE_MEDIO_IMPUESTOS=mean(IMPORTE_CON_IMPUESTOS) )
NUM_TRANSACCIONES_C = as.data.frame(datset %>%filter(CODIGO == 22336) %>%
                                      group_by(FECHA) %>%
                                      dplyr::summarise( unique(ID_TICKET) ) %>%
                                      group_by(FECHA) %>%
                                      dplyr::summarise(n()))$'n()'
VolVentas_CALCIO_FECHA$NUM_TRANSACCIONES =NUM_TRANSACCIONES_C
VolVentas_CALCIO_FECHA=VolVentas_CALCIO_FECHA[,c(1,2,6,3:5)]



VolVentas_SIN_CALCIO_FECHA = dataset %>% 
  filter(CODIGO == 20445) %>% 
  group_by(FECHA) %>%
  dplyr::summarise(VENTAS = sum(CANTIDAD),
                   PRECIO_MEDIO_IMPUESTOS = mean(PRECIO_CON_IMPUESTOS),
                   DESCUENTO_MEDIO = mean(DESCUENTO),
                   IMPORTE_MEDIO_IMPUESTOS=mean(IMPORTE_CON_IMPUESTOS) )
NUM_TRANSACCIONES_SC = as.data.frame(datset %>%
                                       filter(CODIGO == 20445) %>% 
                                       group_by(FECHA) %>%
                                       dplyr::summarise( unique(ID_TICKET) ) %>%
                                       group_by(FECHA) %>%
                                       dplyr::summarise(n()))$'n()'
VolVentas_SIN_CALCIO_FECHA$NUM_TRANSACCIONES =NUM_TRANSACCIONES_SC
VolVentas_SIN_CALCIO_FECHA=VolVentas_SIN_CALCIO_FECHA[,c(1,2,6,3:5)]
```


```{r}
# VENTAS TOTALES 
VolVentas_FECHA$ANO         <-  year(VolVentas_FECHA$FECHA) 
VolVentas_FECHA$MES         <- month(VolVentas_FECHA$FECHA) 
VolVentas_FECHA$DIA         <-   day(VolVentas_FECHA$FECHA) 
VolVentas_FECHA$SEMANA_ANO <-   week(VolVentas_FECHA$FECHA) 
VolVentas_FECHA$DIA_SEMANA <-   wday(VolVentas_FECHA$FECHA,week_start = 1 )
VolVentas_FECHA$ANO <-       factor(VolVentas_FECHA$ANO)
VolVentas_FECHA$MES <-       factor(VolVentas_FECHA$MES)
VolVentas_FECHA$DIA <-       factor(VolVentas_FECHA$DIA)
VolVentas_FECHA$SEMANA_ANO<- factor(VolVentas_FECHA$SEMANA_ANO)
VolVentas_FECHA$DIA_SEMANA<- factor(VolVentas_FECHA$DIA_SEMANA) 

# PROD CON CALCIO
VolVentas_CALCIO_FECHA$ANO         <-  year(VolVentas_CALCIO_FECHA$FECHA) 
VolVentas_CALCIO_FECHA$MES         <- month(VolVentas_CALCIO_FECHA$FECHA) 
VolVentas_CALCIO_FECHA$DIA         <-   day(VolVentas_CALCIO_FECHA$FECHA) 
VolVentas_CALCIO_FECHA$SEMANA_ANO <-   week(VolVentas_CALCIO_FECHA$FECHA) 
VolVentas_CALCIO_FECHA$DIA_SEMANA <-   wday(VolVentas_CALCIO_FECHA$FECHA,week_start = 1 )
VolVentas_CALCIO_FECHA$ANO <-       factor(VolVentas_CALCIO_FECHA$ANO)
VolVentas_CALCIO_FECHA$MES <-       factor(VolVentas_CALCIO_FECHA$MES)
VolVentas_CALCIO_FECHA$DIA <-       factor(VolVentas_CALCIO_FECHA$DIA)
VolVentas_CALCIO_FECHA$SEMANA_ANO<- factor(VolVentas_CALCIO_FECHA$SEMANA_ANO)
VolVentas_CALCIO_FECHA$DIA_SEMANA<- factor(VolVentas_CALCIO_FECHA$DIA_SEMANA)

# PROD SIN CALCIO
VolVentas_SIN_CALCIO_FECHA$ANO         <-  year(VolVentas_SIN_CALCIO_FECHA$FECHA) 
VolVentas_SIN_CALCIO_FECHA$MES         <- month(VolVentas_SIN_CALCIO_FECHA$FECHA) 
VolVentas_SIN_CALCIO_FECHA$DIA         <-   day(VolVentas_SIN_CALCIO_FECHA$FECHA) 
VolVentas_SIN_CALCIO_FECHA$SEMANA_ANO <-   week(VolVentas_SIN_CALCIO_FECHA$FECHA) 
VolVentas_SIN_CALCIO_FECHA$DIA_SEMANA <-   wday(VolVentas_SIN_CALCIO_FECHA$FECHA,week_start = 1 )
VolVentas_SIN_CALCIO_FECHA$ANO <-       factor(VolVentas_SIN_CALCIO_FECHA$ANO)
VolVentas_SIN_CALCIO_FECHA$MES <-       factor(VolVentas_SIN_CALCIO_FECHA$MES)
VolVentas_SIN_CALCIO_FECHA$DIA <-       factor(VolVentas_SIN_CALCIO_FECHA$DIA)
VolVentas_SIN_CALCIO_FECHA$SEMANA_ANO<- factor(VolVentas_SIN_CALCIO_FECHA$SEMANA_ANO)
VolVentas_SIN_CALCIO_FECHA$DIA_SEMANA<- factor(VolVentas_SIN_CALCIO_FECHA$DIA_SEMANA)
```



Los conjuntos de datos para el entrenamiento de modelos predictivos constan de las siguientes variables: fecha, precio medio con impuestos, descuento medio, año, mes, día, semana del año y día de la semana.



Para los modelos de Regresión Lineal es necesario tener un conjunto de datos con variables *dummy* para el día de la semana y el mes del año, con la intención de representar la pertenencia de cada instancia a los distintos grupos. Posteriormente, es necesario factorizar estas nuevas variables, ya que es algo imprescindible para ejecutar el modelo.

Para la creación de variables *dummy*, definimos una función *crea_col_dummy*, que hace uso de la función mutate y spread. 

```{r}
VolVentas_FECHA_poiss           = VolVentas_FECHA
VolVentas_CALCIO_FECHA_poiss    = VolVentas_CALCIO_FECHA
VolVentas_SIN_CALCIO_FECHA_poiss= VolVentas_SIN_CALCIO_FECHA
```




```{r echo=TRUE}

crea_col_dummy <- function(DataFrame, Columna) {
  DataFrame %>% 
    mutate(valor = 1) %>% 
    spread(key = Columna, value = valor, fill = 0)
}

VolVentas_FECHA_poiss = 
  crea_col_dummy(VolVentas_FECHA_poiss,"DIA_SEMANA")

VolVentas_CALCIO_FECHA_poiss= 
  crea_col_dummy(VolVentas_CALCIO_FECHA_poiss,"DIA_SEMANA")

VolVentas_SIN_CALCIO_FECHA_poiss= 
  crea_col_dummy(VolVentas_SIN_CALCIO_FECHA_poiss,
                                                 "DIA_SEMANA")
```


```{r}
colnames(VolVentas_FECHA_poiss)= c("FECHA" ,"VENTAS","NUM_TRANSACCIONES"   ,"PRECIO_MEDIO_IMPUESTOS"  ,"DESCUENTO_MEDIO","IMPORTE_MEDIO_IMPUESTOS","ANO","MES","DIA","SEMANA_ANO","LUNES", "MARTES", "MIERCOLES", "JUEVES", "VIERNES", "SABADO", "DOMINGO" )
colnames(VolVentas_CALCIO_FECHA_poiss)= c("FECHA" ,"VENTAS","NUM_TRANSACCIONES"   ,"PRECIO_MEDIO_IMPUESTOS"  ,"DESCUENTO_MEDIO","IMPORTE_MEDIO_IMPUESTOS","ANO","MES","DIA","SEMANA_ANO","LUNES", "MARTES", "MIERCOLES", "JUEVES", "VIERNES", "SABADO", "DOMINGO" )
colnames(VolVentas_SIN_CALCIO_FECHA_poiss)= c("FECHA" ,"VENTAS","NUM_TRANSACCIONES"   ,"PRECIO_MEDIO_IMPUESTOS"  ,"DESCUENTO_MEDIO","IMPORTE_MEDIO_IMPUESTOS","ANO","MES","DIA","SEMANA_ANO","LUNES", "MARTES", "MIERCOLES", "JUEVES", "VIERNES", "SABADO", "DOMINGO" )
```


```{r echo=TRUE}
VolVentas_FECHA_poiss = 
  crea_col_dummy(VolVentas_FECHA_poiss,"MES")

VolVentas_CALCIO_FECHA_poiss= 
  crea_col_dummy(VolVentas_CALCIO_FECHA_poiss,"MES")

VolVentas_SIN_CALCIO_FECHA_poiss=
  crea_col_dummy(VolVentas_SIN_CALCIO_FECHA_poiss,"MES")
```


```{r }
colnames(VolVentas_FECHA_poiss)= c("FECHA" ,"VENTAS","NUM_TRANSACCIONES"   ,"PRECIO_MEDIO_IMPUESTOS"  ,"DESCUENTO_MEDIO","IMPORTE_MEDIO_IMPUESTOS","ANO","DIA","SEMANA_ANO","LUNES", "MARTES", "MIERCOLES", "JUEVES", "VIERNES", "SABADO", "DOMINGO","ENERO","AGOSTO",   "SEPTIEMBRE",    "OCTUBRE","NOVIEMBRE","DICIEMBRE"  )
colnames(VolVentas_CALCIO_FECHA_poiss)= c("FECHA" ,"VENTAS","NUM_TRANSACCIONES"   ,"PRECIO_MEDIO_IMPUESTOS"  ,"DESCUENTO_MEDIO","IMPORTE_MEDIO_IMPUESTOS","ANO","DIA","SEMANA_ANO","LUNES", "MARTES", "MIERCOLES", "JUEVES", "VIERNES", "SABADO", "DOMINGO","ENERO","AGOSTO",   "SEPTIEMBRE",    "OCTUBRE","NOVIEMBRE","DICIEMBRE"  )
colnames(VolVentas_SIN_CALCIO_FECHA_poiss)= c("FECHA" ,"VENTAS","NUM_TRANSACCIONES"   ,"PRECIO_MEDIO_IMPUESTOS"  ,"DESCUENTO_MEDIO","IMPORTE_MEDIO_IMPUESTOS","ANO","DIA","SEMANA_ANO","LUNES", "MARTES", "MIERCOLES", "JUEVES", "VIERNES", "SABADO", "DOMINGO","ENERO","AGOSTO",   "SEPTIEMBRE",    "OCTUBRE","NOVIEMBRE","DICIEMBRE"  )
```




```{r}
VolVentas_FECHA_poiss=mutate_at(VolVentas_FECHA_poiss, vars("ANO","DIA","SEMANA_ANO","LUNES", "MARTES", "MIERCOLES", "JUEVES", "VIERNES", "SABADO", "DOMINGO","ENERO","AGOSTO",   "SEPTIEMBRE",    "OCTUBRE","NOVIEMBRE","DICIEMBRE" ), as.factor)
VolVentas_CALCIO_FECHA_poiss=mutate_at(VolVentas_CALCIO_FECHA_poiss, vars("ANO","DIA","SEMANA_ANO","LUNES", "MARTES", "MIERCOLES", "JUEVES", "VIERNES", "SABADO", "DOMINGO","ENERO","AGOSTO",   "SEPTIEMBRE",    "OCTUBRE","NOVIEMBRE","DICIEMBRE" ), as.factor)
VolVentas_SIN_CALCIO_FECHA_poiss=mutate_at(VolVentas_SIN_CALCIO_FECHA_poiss, vars("ANO","DIA","SEMANA_ANO","LUNES", "MARTES", "MIERCOLES", "JUEVES", "VIERNES", "SABADO", "DOMINGO","ENERO","AGOSTO",   "SEPTIEMBRE",    "OCTUBRE","NOVIEMBRE","DICIEMBRE" ), as.factor)

```




Una vez tenemos los cuatro conjuntos de datos, tres con los correspondientes volúmenes de ventas diarios y el dataset inicial con el pre procesado necesario, procedemos a guardarlos en formato RData para poder acceder a ellos en cualquier momento que sea necesario.

```{r , echo=TRUE}
save(dataset,file = "Datos/Dataset_Final.RData")
save(VolVentas_SIN_CALCIO_FECHA,file = "Datos/VENTAS_Dia_SCALCIO.RData")
save(VolVentas_CALCIO_FECHA,file = "Datos/VENTAS_Dia_CALCIO.RData")
save(VolVentas_FECHA,file = "Datos/VENTAS_Dia_TOTAL.RData")

save(VolVentas_FECHA_poiss,
     file = "Datos/VENTAS_Dia_TOTAL_poiss.RData")
save(VolVentas_CALCIO_FECHA_poiss,
     file = "Datos/VENTAS_Dia_CALCIO_poiss.RData")
save(VolVentas_SIN_CALCIO_FECHA_poiss,
     file = "Datos/VENTAS_Dia_SCALCIO_poiss.RData")
```




### Análisis exploratorio de datos (EDA)



Una vez hemos realizado el preprocesamiento de los datos necesario, procedemos a la fase del análisis exploratorio.

Este apartado lo dedicaremos a hacer un análisis profundo de las ventas, añadiendo gráficos que muestren el comportamiento del consumidor.

Como tenemos datos correspondientes a ventas, trataremos de responder a las siguientes cuestiones:

- ¿Cuál es el patrón de venta de cada producto? ¿Se venden las mismas unidades, o destaca la venta de uno de ellos?
- ¿Cómo varían las ventas en función del tiempo?
- ¿Qué variables podrían influir más a la hora de vender un producto?


#### Resumen de los datos






```{r ,echo=TRUE, size="footnotesize"}
VolVentas_FECHA[,c(1:6)] %>% summary()  # Resumen de los datos
```



Observamos lo siguiente: 

- La cantidad media diaria de productos vendidos es de 1978 unidades, con una media diaria de 537 transacciones
- El precio medio (con impuestos) de los productos es de 1.44€, siendo el importe medio diario de venta de 3.58€
- El descuento medio no llega a los 10 céntimos de euro.


```{r}
#dataset %>% group_by(ID_TICKET) %>% dplyr::summarise(sum(CANTIDAD)) %>% summary()
#dataset %>% group_by(ID_TICKET) %>% dplyr::summarise(mean(IMPORTE_CON_IMPUESTOS)) %>% summary()
```

Analizando el número de items vendidos y el importe de venta, es interesante mencionar que de media, se han vendido cuatro items por transacción, con un precio medio de 4.25€.
El 75% de las ventas ha sido de seis items o menos, habiendo transacciones donde el número de productos ascendía hasta las 132 unidades. Con respecto al importe de venta (con impuestos), éste ha variando desde los 69 céntimos a los 196.68€. Sin embargo únicamente el 25% de las transacciones han sido de más de 8.34€. 





```{r  , include=FALSE}
# A continuación mostramos brevemente algunas de las filas de nuestros datos:

dataset %>% head() %>% 
  kable(booktabs=TRUE) %>%
  kable_styling(latex_options = c("striped","scale_down","HOLD_position"))
```



Las `r nrow(dataset)` filas encontradas en el conjunto de datos corresponden a `r length(dataset$ID_TICKET %>% unique())` ventas diferentes.





#### Representaciones gráficas



En primer lugar, podemos ver gráficamente la evolución del volumen total de ventas diarias:


```{r}
VolumenVentasDiarias = dataset %>% group_by(FECHA,ID_TICKET) %>%  dplyr::summarize(n =  n()) %>% as.data.frame() %>% group_by(FECHA) %>%  dplyr::summarize(n =  n())
VolumenVentasDiarias = VolumenVentasDiarias %>% mutate(CODIGO = rep("TOTAL",nrow(VolumenVentasDiarias)))


VolumenVentasDiarias_P1=dataset %>% filter(CODIGO==20445) %>% group_by(FECHA,ID_TICKET) %>%  dplyr::summarize(n =  n()) %>% as.data.frame() %>% group_by(FECHA) %>%  dplyr::summarize(n =  n())
VolumenVentasDiarias_P1 = VolumenVentasDiarias_P1 %>% mutate(CODIGO = rep(20445,nrow(VolumenVentasDiarias_P1)))

VolumenVentasDiarias_P2=dataset %>% filter(CODIGO==22336) %>% group_by(FECHA,ID_TICKET) %>%  dplyr::summarize(n =  n()) %>% as.data.frame() %>% group_by(FECHA) %>%  dplyr::summarize(n =  n())
VolumenVentasDiarias_P2 = VolumenVentasDiarias_P2 %>% mutate(CODIGO = rep(22336,nrow(VolumenVentasDiarias_P2)))

VolumenVentasDiarioTodo=
rbind.data.frame(VolumenVentasDiarias,VolumenVentasDiarias_P1,VolumenVentasDiarias_P2)
```




```{r , fig.height=5}
# La idea en shiny es poder mostrar con un gráfico interactivo las ventas totales según   # día, volumen medio de ventas mensuales, semanales,... es fácil solo es crear un dataset # con esta información

ggplot(VolumenVentasDiarioTodo )+
  geom_line(aes(x=FECHA, y = n, group=CODIGO, colour=CODIGO)  ) +
  scale_x_date(date_labels = "%d %b %y",date_breaks = "15 days")+
  labs(x="Día" , y = "Volumen total de ventas", caption = "Fuente: Elaboración propia con datos")+
 theme_gray() +
  theme(axis.text.x = element_text(angle = 45))+
  ggtitle("Evolución del volumen total de ventas diario")
  
```



En el gráfico podemos apreciar como el volumen de ventas diario fluctúa bastante en función del día, encontrándolas en un rango entre 17 y 1440 ventas diarias. Hay dos momentos donde el volumen de ventas es considerablemente superior al resto, a mediados del mes de Octubre de 2020 y a mediados de Diciembre de este mismo año. Se observa un patrón muy marcado, con picos de muy pocas ventas y otros donde el volumen sube bastante para ambos productos, sin embargo, podemos afirmar que las ventas son ligeramente superiores para el producto con calcio (22336).





A continuación, vamos a hacer una comparación del volumen de ventas total por productos:

```{r}
Ventas_Prod=cbind.data.frame(
VENTAS_TOTALES=c(VolVentas_SIN_CALCIO_FECHA$VENTAS %>% sum(),VolVentas_CALCIO_FECHA$VENTAS %>% sum()),
TIPO = c("SIN CALCIO","CON CALCIO") ) 
```





```{r , fig.height=3 , fig.width=5 , fig.align='center'}
ggplot(Ventas_Prod, aes(fill =TIPO , x = TIPO , y=VENTAS_TOTALES)) + 
  geom_histogram(stat="identity", position="dodge")   +
  labs(x="ID Producto" , y = "Volumen total de ventas", 
       caption = "Fuente: Elaboración propia con datos de ventas")+
 scale_fill_brewer(palette="BuGn")+
  theme_bw()+ theme(legend.position = 'none')+
  ggtitle("Comparación de ventas por tipo de producto")
```



El volumen de ventas del producto con calcio ha sido ligeramente superior, con un volumen total de ventas de 188867 unidades frente a las 169196 unidades vendidas del producto que no lleva calcio. 

El importe de venta del producto con calcio es de 1.49€ (precio con impuestos) y el producto que no lleva calcio tiene un precio de venta de 1.39€. Esto nos conduce a que los usuarios no han optado siempre por la compra de la opción más económica, sino que han comprado en un mayor número de ocasiones el producto con calcio.

En la tabla que se muestra a continuación, vemos que en las transacciones donde aparece el producto con calcio, han tenido un importe medio de venta ligeramente superior que en las que aparece el producto sin calcio.


```{r }
dataset %>% select(ID_TICKET,TIPO,IMPORTE_CON_IMPUESTOS,PRECIO_CON_IMPUESTOS) %>% 
  group_by( TIPO) %>% 
  dplyr::summarise(IMPORTE_MEDIO= round(mean(IMPORTE_CON_IMPUESTOS),2),
                   PRECIO_MEDIO= round(mean(PRECIO_CON_IMPUESTOS),2)) %>% 
  kable(booktabs=TRUE, caption="Importe medio de venta y precio por producto.",align = 'c',
          col.names = c("Tipo producto","Importe medio transacción","Precio medio producto")) %>% 
  kable_styling(latex_options = c("striped","HOLD_position"))
```






Para tratar de entender mejor el comportamiento de venta, vamos a estudiar la evolución de los valores de ventas en función del día de la semana y mes del año.







```{r}
VENTAS_MENSUALES = 
rbind.data.frame(
  VolVentas_CALCIO_FECHA %>% group_by(MES) %>% dplyr::summarise(TOTAL_VENTAS = sum(VENTAS)) %>% mutate(TIPO = "CON CALCIO"),
  VolVentas_SIN_CALCIO_FECHA %>% group_by(MES) %>% dplyr::summarise(TOTAL_VENTAS=sum(VENTAS))%>% mutate(TIPO = "SIN CALCIO"),
  VolVentas_FECHA %>% group_by(MES) %>% dplyr::summarise(TOTAL_VENTAS=sum(VENTAS))%>% mutate(TIPO = "TOTAL") ) 

VENTAS_MENSUALES$MES=c(
ifelse(VENTAS_MENSUALES$MES == 1 , "Enero",
       ifelse(
          VENTAS_MENSUALES$MES == 8 , "Agosto",
       ifelse(
         VENTAS_MENSUALES$MES == 9 , "Septiembre",
         ifelse( VENTAS_MENSUALES$MES == 10 , "Octubre",
                 ifelse(
                    VENTAS_MENSUALES$MES == 11 , "Noviembre",
                    ifelse(VENTAS_MENSUALES$MES == 12 , "Diciembre"," " ))))))
)
```



```{r ,fig.height=3 , fig.width=6}
# Aquí no ventas medias, ya que solo hay un mes, no hay varios años
ggplot(VENTAS_MENSUALES, aes(fill =TIPO , x = MES , y=TOTAL_VENTAS)) + 
  geom_histogram(stat="identity", position="dodge") +  
   scale_x_discrete(limits = c("Agosto","Septiembre","Octubre","Noviembre","Diciembre","Enero"))+
labs(x="Mes" , y = "Volumen de ventas", caption = "Fuente: Elaboración propia con datos de ventas diarias")+
scale_fill_brewer(palette="BuGn")+
  theme_bw()+ #theme(legend.position = 'none')+
  ggtitle("Nº total de artículos vendidos según mes del año")
```


Inicialmente, podemos ver una tendencia creciente del número de ventas total, donde se tiende a vender más cada mes.Sin embargo, en el mes de Octubre se alcanza un maximo de artículos vendidos, con un total de 68805 artículos. En los meses siguientes el comportamiento fué de una disminución de la venta, con posterior subida del número de artículos vendidos y luego otro descenso. La tendencia general de venta de artículos es creciente, la clientela tiende a comprar más productos cada vez.
Respecto a las ventas de cada producto individual, todos los meses ha sido mayor el volumen de venta del artículo con calcio, alcanzándose en el mes de Octubre el mayor número de artículos vendidos de cada tipo, superando en ambos casos las treinta y dos mil unidades vendidas.










```{r}
VENTAS_SEMANALES = 
rbind.data.frame(
  
  VolVentas_CALCIO_FECHA %>% group_by(DIA_SEMANA) %>% dplyr::summarise(VENTAS_MEDIAS = ceiling(mean(VENTAS)) ) %>% mutate(TIPO = "CON CALCIO"),
  
  VolVentas_SIN_CALCIO_FECHA %>% group_by(DIA_SEMANA) %>% dplyr::summarise(VENTAS_MEDIAS=ceiling(mean(VENTAS)) )%>% mutate(TIPO = "SIN CALCIO"),
  
  VolVentas_FECHA %>% group_by(DIA_SEMANA) %>% dplyr::summarise(VENTAS_MEDIAS=ceiling(mean(VENTAS)) )%>% mutate(TIPO = "TOTAL") ) 


VENTAS_SEMANALES$DIA_SEMANA=c(
ifelse(VENTAS_SEMANALES$DIA_SEMANA == 1 , "Lunes",
       ifelse(
          VENTAS_SEMANALES$DIA_SEMANA == 2 , "Martes",
       ifelse(
        VENTAS_SEMANALES$DIA_SEMANA== 3 , "Miércoles",
         ifelse( VENTAS_SEMANALES$DIA_SEMANA == 4 , "Jueves",
                 ifelse(
                    VENTAS_SEMANALES$DIA_SEMANA == 5 , "Viernes",
                    ifelse(VENTAS_SEMANALES$DIA_SEMANA == 6 , "Sábado",
                           ifelse(VENTAS_SEMANALES$DIA_SEMANA == 7 , "Domingo",""))))))))
```



```{r ,fig.height=3 , fig.width=6}
# Aquí no ventas medias, ya que solo hay un mes, no hay varios años
ggplot(VENTAS_SEMANALES, aes(fill =TIPO , x = DIA_SEMANA , y=VENTAS_MEDIAS)) + 
  geom_histogram(stat="identity", position="dodge") +  
   scale_x_discrete(limits = c("Lunes","Martes","Miércoles","Jueves","Viernes","Sábado","Domingo"))+
labs(x="Mes" , y = "Volumen medio de ventas", caption = "Fuente: Elaboración propia con datos de ventas diarias")+
scale_fill_brewer(palette="BuGn")+
  theme_bw()+ #theme(legend.position = 'none')+
  ggtitle(label = "Comparación del número medio de artículos vendidios",subtitle = "Según día de la semana")
```




Observando el gráfico, vemos que el Sábado es el día de la semana donde el número de artículos vendidos es mayor, con un total de 2323 items. Por el contrario, el Domingo no se superan ni los 250 artículos vendidos, en media. Cabe destacar que los Domingos se ha vendido, de media, mayor número de items sin calcio, comportamiento que no había ocurrido hasta el momento. Los Jueves es un día donde también se tiende a vender gran candidad de productos. 








##### Variable precio



El precio medio de venta del producto que no lleva calcio es de `r (dataset %>%group_by(ID_TICKET) %>% filter( CODIGO == 20445))$PRECIO  %>% mean() %>% round(2)`€, habiendo variado entre los `r (dataset %>%group_by(ID_TICKET) %>% filter( CODIGO == 20445))$PRECIO  %>% min()` y los `r (dataset %>%group_by(ID_TICKET) %>% filter( CODIGO == 20445))$PRECIO  %>% max() %>% round(2)` €.


Para el artículo con calcio el precio medio es algo superior: `r (dataset %>%group_by(ID_TICKET) %>% filter( CODIGO == 22336))$PRECIO  %>% mean() %>% round(2)`€, con un precio mínimo de `r (dataset %>%group_by(ID_TICKET) %>% filter( CODIGO == 22336))$PRECIO  %>% min() %>% round(2)` € y un máximo de `r (dataset %>%group_by(ID_TICKET) %>% filter( CODIGO == 22336))$PRECIO  %>% max() %>% round(2)` euros.



Vamos a estudiar esta variable, tratando de averiguar si esta variación se debe a la época del año o al número de artículos comprado, ya que podría haber promociones para tratar de impulsar las ventas donde los precios pudieran verse afectados. 

Los precios de los productos varían debido a descuentos aplicados a todos los artículos de una misma compra en función del importe de la misma, por ejemplo, si se superan los 50€, se hará un 10% de descuento, y por tanto, habremos pagado menos por cada artículo. Sin embargo, la variable descuento, se aplica a cada artículo de manera individual, por ejemplo, en la transacción con identificador 22551535 se vendieron 6 unidades del producto 22336 por un precio de 1.49€ (impuestos incluidos) cada unidad, lo que supone un total de 8.94€ por las 6 unidades, pero se ha aplicado un descuento del 5.03%.

```{r}
dataset %>% filter(ID_TICKET ==22551535 ) %>% select(c("ID_TICKET","LINEA_TICKET","CODIGO","CANTIDAD","PRECIO_CON_IMPUESTOS","DESCUENTO","IMPORTE_CON_IMPUESTOS")) %>% kable() %>% kable_styling(latex_options = "scale_down")
```



Se ha aplicado descuento en un total de `r dataset[dataset$DESCUENTO !=0,] %>% nrow()` artículos, siendo el descuento medio aplicado del `r round( dataset[dataset$DESCUENTO !=0,]$DESCUENTO %>% mean(),2)`% respecto del importe total de la venta. Estos descuentos han sido aplicados durante todo el período temporal estudiado. El mayor descuento aplicado ha sido del 50%, aplicado en dos ocasiones a mediados de Diciembre. En el gráfico mostrado a continuación, se presenta un histograma comparativo del volumen de ventas total de cada producto en función del descuento habiendo dividido los datos en tres intervalos de tal manera que se ha tomado la distribución de los deciles de esta variable: 

```{r}
dataset[dataset$DESCUENTO !=0,]$DESCUENTO %>% quantile(probs= seq(0,1,by=0.1))
```

Lo que podemos observar es que donde se acentúa más la diferencia del volumen de ventas es al aplicar los mayores descuentos, en un 10% del total de observaciones.




```{r , fig.height=4 }
# par(mfrow=c(1,3))
# ggplot(dataset[dataset$DESCUENTO < 10.00 & dataset$DESCUENTO>=3.66,] %>% group_by(TIPO) %>% # dplyr::summarise(VENTAS=sum(CANTIDAD))%>% mutate(DESCUENTO = "[3.66,10)")
#        , aes(fill =TIPO , x = TIPO , y=VENTAS)) + 
#   geom_histogram(stat="identity", position="dodge") +
#   labs(x="Descuento aplicado" , y = "Volumen total de ventas")+
# scale_fill_brewer(palette="BuGn")+
#   theme_bw()+ theme(legend.position = 'none')+
#   ggtitle(label = "Descuento del 3.66% al 9.99%")
# 
# 
# ggplot(dataset[dataset$DESCUENTO >= 10.00 & dataset$DESCUENTO < 14.99,] %>% group_by(TIPO) %>% # dplyr::summarise(VENTAS=sum(CANTIDAD)) %>% mutate(DESCUENTO = "[10,14.99)")
#        , aes(fill =TIPO , x = TIPO , y=VENTAS)) + 
#   geom_histogram(stat="identity", position="dodge") +
#   labs(x="Descuento aplicado" , y = "Volumen total de ventas")+
# scale_fill_brewer(palette="BuGn")+
#   theme_bw()+ theme(legend.position = 'none')+
#     ggtitle(label = "Descuento del 10% al 14.98%")

ggplot(dataset[dataset$DESCUENTO >= 14.99,] %>% group_by(TIPO) %>% dplyr::summarise(VENTAS=sum(CANTIDAD))%>% mutate(DESCUENTO = "[14.99,50]")
       , aes(fill =TIPO , x = TIPO , y=VENTAS)) + 
  geom_histogram(stat="identity", position="dodge") +
  labs(x="Descuento aplicado" , y = "Volumen total de ventas")+
scale_fill_brewer(palette="BuGn")+
  theme_bw()+ theme(legend.position = 'none')+
    ggtitle(label = "Descuento del 14.99% o más")

par(mfrow=c(1,3))
```

#### Grado de asociación de las variables

En la matriz de correlación mostrada a continuación podemos ver el grado de asociación de las diferentes variables entre sí y con la variable objetivo, *ventas*.


```{r }
#VolVentas_FECHA=mutate_at(VolVentas_FECHA, vars("ANO","DIA","SEMANA_ANO","MES","DIA_SEMANA"  ), as.numeric)
#M = cor(VolVentas_FECHA[,-1])
#MatCorr = corrplot(M, method = "number",type = 'lower', diag = FALSE, number.cex = 0.9,
#         tl.col = 'black', cl.ratio = 0.1, tl.srt = 35)
```




```{r echo=FALSE,fig.align='center',out.width='65%',fig.cap="\\label{fig:shiny3}Matr\\'iz de correlaci\\'on. Fuente: elaboraci\\'on propia con datos de ventas.",fig.pos="H"}

knitr::include_graphics("graficos/MAtrizCorrelacion.png")
```





Observamos como el grado de asociación positiva entre la variable número de transacciones diaria y la variable objetivo, ventas diarias (número de items) es muy elevado, indicando así que conforme más transacciones se hayan producido, mayor número de artículos se venderán. También tienen una correlación importante la variable volumen de ventas e importe medio con impuestos de la transacción. El comportamiento es similar en los conjuntos de datos individuales para cada producto.



```{r}
# library(SmartEDA)
#  ExpCatStat(VolVentas_FECHA,Target="VENTAS",result = # "Stat",clim=10,nlim=5,bins=10,Pclass="Yes",plot=TRUE,top=10,Round=2)
```






