---
author: "Nombre Completo Autor"
date: "27/10/2017"
documentclass: book
forprint: true  # true: imprime a dos caras, false: libro digital
fontsize: 12pt # 10pt,11pt
geometry: margin = 2.5cm 
bibliography: ["bib/library.bib", "bib/paquetes.bib"]
# metodobib -> true: natbib (descomentar: citation_package: natbib) 
#           -> false: pandoc (comentar: citation_package: natbib)
metodobib: true
#natbib: plainnat, abbrvnat, unsrtnat
biblio-style: "plainnat"
#Método 2 (pandoc): descomente una línea de las 2 siguientes en caso de usarlo
csl: methods-in-ecology-and-evolution.csl      # no numera mejor en las citas
#csl: acm-sig-proceedings-long-author-list.csl  # numera peor en las citas
link-citations: yes
output: 
  pdf_document:
    keep_tex: no
    number_sections: yes
    citation_package: natbib  # comentado usa: pandoc-citeproc
    #toc: yes
    fig_caption: yes
    template: latex/templateMemoriaTFE.tex
    includes:
      #before_body: portadas/latex_paginatitulo_modTFE.tex
      #in_header: latex/latex_preambulo.tex
      #after_body: latex/latex_antes_enddoc.tex
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE , warning = FALSE , message = FALSE , fig.pos = 'H')
```

```{r , librerias, message=FALSE , echo= FALSE}
library(tidyverse)
library(dplyr)
library(kableExtra)

library(plyr) # Transformación de los datos
library(dplyr)


library(lubridate)
library(ggplot2) # Visualización
library(hrbrthemes) # Temas 
```




## Modelos estadísticos clásicos



El objetivo principal de este apartado es aplicar los modelos estadísticos descritos en la parte teórica a un conjunto de datos correspondiente a ventas de dos productos lácteos de dos marcas distintas.

En primer lugar, se aplicarán distintos modelos estadísticos clásicos con el objetivo de entender como funcionan las ventas y predecir el volumen de ventas de ambos productos en el futuro. Con este objetivo, trataremos de identificar que variables son las mas adecuadas para la realización de las predicciones. También estudiaremos la existencia de variables que no aportan información adicional al volumen de ventas, y son por tanto irrelevantes para este estudio.


Para llevar a cabo este estudio haremos uso de la librería *-*




### Lectura y descripción de los datos



```{r , carga de datos}
load("Datos/datosTFGMarta.RData")
```




Los datos contienen información correspondiente a ventas de productos lácteos desde el 1 de Septiebre de 2020 hasta el 30 de Enero de 2022, obteniéndose un total de 140025 observaciones y se estructuran de la siguiente forma: Cada fila corresponde a la línea de un ticket y hace referencia a la venta de un artículo en particular. De esta forma, para una venta de un único producto únicamente encontraremos una fila en el conjunto de datos que identifique esa venta, sin embargo, para una venta de más de un artículo encontraremos tantas filas como productos se hayan vendido. Como únicamente tenemos las ventas para dos productos, como máximo, habrá dos filas en el conjunto de datos para una misma venta.


En este conjunto de datos inicial encontramos las siguientes variables:

- **ID_TICKET**: Variable numérica que identifica unívocamente a cada ticket de compra
- **LINEA_TICLET**: Variable numérica con la línea correspondiente del ticket
- **FECHA**: Fecha en que se realizó la transacción
- **CODIGO**: Id producto
- **CANTIDAD**: Número de artículos comprados
- **PRECIO**: Precio base del artículo libre de impuestos, euros
- **PRECIO CON IMPUESTOS**: Precio de venta del artículo, en  euros
- **DESCUENTO**:  Descuento aplicado
- **IMPORTE**: Importe de la compra libre de impuestos, en euros
- **IMPORTE CON IMPUESTOS**: Importe a pagar por el comprador, en euros




Se ha considerado oportuno la extracción de la siguiente información como nuevas variables temporales: día de la semana, semana del año, mes y año de cada instancia a partir de la variable *fecha* y haciendo uso de la librería lubridate. De esta forma, se podrá hacer un análisis del comportamiento de ventas teniendo en cuenta distintas granularidades tratando de ver si la temporalidad afecta a la venta de productos.




```{r , extraccion_fecha}
datos$ANO         <- year(datos$FECHA) # extraemos el año
datos$MES         <- month(datos$FECHA) # extraemos el mes
datos$DIA         <-day(datos$FECHA) # extraemos el día
datos$SEMANA_ANO <-week(datos$FECHA)
datos$DIA_SEMANA <-wday(datos$FECHA,week_start = 1 )
```


```{r , reordenacion_cols}
# Reordeno las columnas 
datos <- datos %>% select("ID_TICKET"  , "LINEA_TICKET", "CODIGO", "CANTIDAD", "PRECIO", "PRECIO_CON_IMPUESTOS" , "DESCUENTO", "IMPORTE", "IMPORTE_CON_IMPUESTOS" , "FECHA" , "ANO", "MES"    , "DIA", "SEMANA_ANO", "DIA_SEMANA"  )
```





```{r , conversion_variables}
datos$ID_TICKET<- as.factor(datos$ID_TICKET) # Conversión a factor
datos$LINEA_TICKET<- as.factor(datos$LINEA_TICKET) # Conversión a factor
datos$CODIGO<- as.factor(datos$CODIGO) # Conversión a factor
datos$CANTIDAD<- as.integer(datos$CANTIDAD) # Conversión a entero
datos$ANO <- as.integer(datos$ANO)
datos$MES <- as.integer(datos$MES)
datos$DIA <- as.integer(datos$DIA)
datos$SEMANA_ANO<- as.integer(datos$SEMANA_ANO)
datos$DIA_SEMANA<- as.integer(datos$DIA_SEMANA)
dataset<-as.data.frame(datos) # Datos como DF
```



Al estar trabajando con fechas, es muy importante comprobar la uniformidad de los datos (no se como expresarlo), para ello buscaremos la existencia de datos faltantes de la siguiente forma:


```{r , missing values}
# Construcción de un cjto de datos con todas las fechas entre la primera fecha y la última de los datos que tenemos
FechasCompletas <- seq(min(dataset$FECHA), max(dataset$FECHA), by = "day")
FechasCompletas  <- data.frame(FECHA = FechasCompletas ) # Creo un DF con de fechas

# Merge al conjunto de fechas completas y al Datos3 para añadir NA a aquellos valores faltantes
DatosCompletos <- merge(FechasCompletas, dataset, by = "FECHA", all.x = TRUE)

# Valores faltantes en el conjunto de datos completo
Miss_values <- which(is.na(DatosCompletos$ANO) == TRUE)
```

Existe un total de `r length(Miss_values)` valores faltantes, que corresponden a un `r round( (length(Miss_values)/nrow(dataset))*100 , 5 )`% del total de datos. Se trata de un porcentaje ínfimo del total, por lo que procedemos a imputar estos valores ¿¿**de que forma**??



Una vez hemos añadido las variables adecuadas, vamos a realizar un breve resumen rescriptivo de los datos para así conocer la estructura y el tipo de éstos y ver si es necesario la modificación de alguna variable.


```{r}
dataset %>% str() # Estructura de los datos trás su transformación
```



```{r}
dataset %>% summary()  # Resumen de los datos
```




```{r , fig.pos="!H" , include=FALSE}
# A continuación mostramos brevemente algunas de las filas de nuestros datos:

dataset %>% head() %>% 
  kable(booktabs=TRUE) %>%
  kable_styling(latex_options = c("striped","scale_down"))
```


A continuación, podemos ver gráficamente la evolución del volumen total de ventas diarias:


```{r}
VolumenVentasDiarias = dataset %>% group_by(FECHA) %>%  dplyr::summarize(n =  n())
```






```{r}
# La idea en shiny es poder mostrar con un gráfico interactivo las ventas totales según día, volumen medio de ventas mensuales, semanales,... es fácil solo es crear un dataset con esta información

ggplot(VolumenVentasDiarias )+
  geom_line(aes(x=VolumenVentasDiarias$FECHA, y = VolumenVentasDiarias$n) , 
            color ="lightblue"  ) +
  scale_x_date(date_labels = "%d %b %y",date_breaks = "15 days")+
  labs(x="Día" , y = "Volumen total de ventas", caption = "Fuente: Elaboración propia con datos")+
  #theme_ipsum() +
  theme(axis.text.x = element_text(angle = 45))+
  ggtitle("Evolución del volumen total de ventas diario")
  
```


En el gráfico podemos apreciar como las ventas fluctuan bastante, encontrándolas en un rango entre 25 y 2268 ventas diarias. Hay dos momentos donde el volumen de ventas es considerablemente superior al resto, a mediados del mes de Octubre de 2020 y a mediados de Diciembre de este mismo año. Se observa un patrón muy marcado, con picos de muy pocas ventas y otros donde el volumen sube.













